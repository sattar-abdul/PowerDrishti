import React, { useState, useEffect, useRef } from "react";
import { useSearchParams, useNavigate } from "react-router-dom";
import { MapContainer, TileLayer, Marker, Popup, useMap, Polyline, useMapEvents } from 'react-leaflet';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { MapPin, Navigation, PlayCircle, StopCircle, Truck, Package, Calendar, Store, MapPinned } from "lucide-react";
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { useAuth } from "@/context/AuthContext";
import { LOCAL_URL } from "@/api/api.js";

// Custom Pin Icon
const pinIcon = new L.Icon({
    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#ef4444" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
      <circle cx="12" cy="10" r="3" fill="#ffffff"></circle>
    </svg>
  `),
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40]
});

// Truck Icon
const truckIcon = new L.Icon({
    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="1" y="3" width="15" height="13"></rect>
      <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
      <circle cx="5.5" cy="18.5" r="2.5" fill="#3b82f6"></circle>
      <circle cx="18.5" cy="18.5" r="2.5" fill="#3b82f6"></circle>
    </svg>
  `),
    iconSize: [40, 40],
    iconAnchor: [20, 20],
    popupAnchor: [0, -20]
});

// Component to handle map clicks for location selection
function LocationPicker({ onLocationSelect }) {
    useMapEvents({
        click(e) {
            onLocationSelect(e.latlng);
        },
    });
    return null;
}

// Component to invalidate map size when container changes
function MapResizer() {
    const map = useMap();
    useEffect(() => {
        const resizeObserver = new ResizeObserver(() => {
            map.invalidateSize();
        });
        const container = map.getContainer();
        resizeObserver.observe(container);
        return () => {
            resizeObserver.disconnect();
        };
    }, [map]);
    return null;
}

// Component to fit bounds to route
function RouteFitter({ source, destination, route }) {
    const map = useMap();
    useEffect(() => {
        if (route && route.length > 0) {
            const bounds = L.latLngBounds(route);
            map.fitBounds(bounds, { padding: [50, 50] });
        } else if (source && destination) {
            const bounds = L.latLngBounds([source, destination]);
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }, [source, destination, route, map]);
    return null;
}

// Helper function to generate curved route like Google Maps
function generateCurvedRoute(start, end, numPoints = 50) {
    const points = [];
    const [startLat, startLng] = start;
    const [endLat, endLng] = end;
    
    // Calculate the midpoint
    const midLat = (startLat + endLat) / 2;
    const midLng = (startLng + endLng) / 2;
    
    // Calculate the perpendicular offset for the curve
    const dx = endLng - startLng;
    const dy = endLat - startLat;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    // Create a curve with offset proportional to distance
    const curvature = distance * 0.2;
    const offsetLat = -dx * curvature;
    const offsetLng = dy * curvature;
    
    // Control point for the bezier curve
    const controlLat = midLat + offsetLat;
    const controlLng = midLng + offsetLng;
    
    // Generate points along the quadratic bezier curve
    for (let i = 0; i <= numPoints; i++) {
        const t = i / numPoints;
        const t1 = 1 - t;
        
        // Quadratic bezier formula
        const lat = t1 * t1 * startLat + 2 * t1 * t * controlLat + t * t * endLat;
        const lng = t1 * t1 * startLng + 2 * t1 * t * controlLng + t * t * endLng;
        
        points.push([lat, lng]);
    }
    
    return points;
}

export default function MaterialTracking() {
    const [searchParams] = useSearchParams();
    const navigate = useNavigate();
    const { token } = useAuth();

    // Existing tracking states
    const [activeOrders, setActiveOrders] = useState([]);
    const [selectedOrder, setSelectedOrder] = useState(null);
    const [trackingData, setTrackingData] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [isTracking, setIsTracking] = useState(false);
    const [progress, setProgress] = useState(0);

    // New states for supplier and location
    const [suppliers, setSuppliers] = useState([]);
    const [selectedSupplier, setSelectedSupplier] = useState(null);
    const [projectLocation, setProjectLocation] = useState(null);
    const [showLocationPicker, setShowLocationPicker] = useState(false);
    const [tempLocation, setTempLocation] = useState(null);
    const [materialInfo, setMaterialInfo] = useState(null);
    const [projectId, setProjectId] = useState(null);
    const [isPlacingOrder, setIsPlacingOrder] = useState(false);
    const [mode, setMode] = useState('tracking'); // 'tracking' or 'ordering'

    // Animation ref
    const requestRef = useRef();
    const startTimeRef = useRef();
    const duration = 60000; // 60 seconds for simulation

    useEffect(() => {
        const initializePage = async () => {
            // Check if we're coming from Monthly Forecast with material info
            const materialId = searchParams.get('materialId');
            const materialName = searchParams.get('materialName');
            const quantity = searchParams.get('quantity');
            const unit = searchParams.get('unit');
            const projId = searchParams.get('projectId');

            if (materialId && materialName && projId) {
                // Ordering mode
                setMode('ordering');
                setMaterialInfo({
                    id: materialId,
                    name: materialName,
                    quantity: parseFloat(quantity),
                    unit: unit
                });
                setProjectId(projId);

                // Fetch project location
                await fetchProjectLocation(projId);

                // Fetch suppliers for this material
                await fetchSuppliersForMaterial(materialId, projId);
            } else {
                // Regular tracking mode
                setMode('tracking');
                fetchActiveOrders();

                const trackingId = searchParams.get('trackingId');
                if (trackingId) {
                    fetchTrackingByTrackingId(trackingId);
                }
            }

            setIsLoading(false);
        };

        initializePage();
    }, []);

    const fetchProjectLocation = async (projId) => {
        try {
            const response = await fetch(`${LOCAL_URL}/api/projects`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.ok) {
                const projects = await response.json();
                const project = projects.find(p => p._id === projId);

                if (project) {
                    if (project.location_set && project.location) {
                        setProjectLocation(project.location);
                    } else {
                        // Show location picker for first time
                        setShowLocationPicker(true);
                        // Set default to India center
                        setTempLocation({ lat: 20.5937, lng: 78.9629 });
                    }
                }
            }
        } catch (error) {
            console.error('Error fetching project location:', error);
        }
    };

    const fetchSuppliersForMaterial = async (materialId, projId) => {
        try {
            // Get project location first
            const response = await fetch(`${LOCAL_URL}/api/projects`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            let projectLat, projectLng;
            if (response.ok) {
                const projects = await response.json();
                const project = projects.find(p => p._id === projId);
                if (project?.location) {
                    projectLat = project.location.lat;
                    projectLng = project.location.lng;
                }
            }

            // Fetch suppliers
            const url = projectLat && projectLng
                ? `${LOCAL_URL}/api/suppliers/material/${materialId}?projectLat=${projectLat}&projectLng=${projectLng}`
                : `${LOCAL_URL}/api/suppliers/material/${materialId}`;

            const suppliersResponse = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (suppliersResponse.ok) {
                const data = await suppliersResponse.json();
                setSuppliers(data.suppliers || []);
            }
        } catch (error) {
            console.error('Error fetching suppliers:', error);
        }
    };

    const handleMapClick = (latlng) => {
        setTempLocation({ lat: latlng.lat, lng: latlng.lng });
    };

    const handleSaveLocation = async () => {
        if (!tempLocation || !projectId) return;

        try {
            const response = await fetch(`${LOCAL_URL}/api/projects/${projectId}/location`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    lat: tempLocation.lat,
                    lng: tempLocation.lng
                })
            });

            if (response.ok) {
                setProjectLocation(tempLocation);
                setShowLocationPicker(false);
                // Refresh suppliers with new location
                await fetchSuppliersForMaterial(materialInfo.id, projectId);
                alert('Project location saved successfully!');
            }
        } catch (error) {
            console.error('Error saving location:', error);
            alert('Failed to save location');
        }
    };

    const handlePlaceOrder = async () => {
        if (!selectedSupplier || !materialInfo || !projectId) {
            alert('Please select a supplier');
            return;
        }

        setIsPlacingOrder(true);
        try {
            const response = await fetch(`${LOCAL_URL}/api/procurement/order`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    projectId,
                    material_name: materialInfo.name,
                    material_id: materialInfo.id,
                    quantity: materialInfo.quantity,
                    unit: materialInfo.unit,
                    supplier_name: selectedSupplier.name,
                    expected_delivery_days: selectedSupplier.average_delivery_days || 14,
                    priority: 'High'
                })
            });

            if (!response.ok) {
                throw new Error('Failed to place order');
            }

            const data = await response.json();
            alert(`Order placed successfully! Tracking ID: ${data.tracking.tracking_id}`);

            // Switch to tracking mode
            setMode('tracking');
            setTrackingData(data.tracking);
            setSelectedOrder(data.order._id);
            setMaterialInfo(null); // Clear material info to show tracking UI
        } catch (error) {
            console.error('Error placing order:', error);
            alert('Failed to place order. Please try again.');
        } finally {
            setIsPlacingOrder(false);
        }
    };

    const fetchActiveOrders = async () => {
        try {
            const response = await fetch(`${LOCAL_URL}/api/tracking/active`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.ok) {
                const data = await response.json();
                setActiveOrders(data);
            }
        } catch (error) {
            console.error("Failed to fetch active orders", error);
        }
    };

    const fetchTrackingByTrackingId = async (trackingId) => {
        try {
            const response = await fetch(`${LOCAL_URL}/api/tracking/${trackingId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.ok) {
                const data = await response.json();
                setTrackingData(data);
                setSelectedOrder(data.order?._id);
            }
        } catch (error) {
            console.error("Failed to fetch tracking data", error);
        }
    };

    const handleOrderSelect = async (orderId) => {
        setSelectedOrder(orderId);
        try {
            const response = await fetch(`${LOCAL_URL}/api/tracking/order/${orderId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.ok) {
                const data = await response.json();
                setTrackingData(data);
            }
        } catch (error) {
            console.error("Failed to fetch tracking data", error);
        }
    };

    const handleStartTracking = async () => {
        if (!trackingData) {
            alert("Please select an order to track");
            return;
        }

        try {
            const response = await fetch(`${LOCAL_URL}/api/tracking/${trackingData.tracking_id}/start`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                setTrackingData(data);
                setIsTracking(true);
                setProgress(0);

                startTimeRef.current = Date.now();
                requestRef.current = requestAnimationFrame(animate);
            }
        } catch (error) {
            console.error("Failed to start tracking", error);
            alert("Failed to start tracking");
        }
    };

    const handleStopTracking = () => {
        setIsTracking(false);
        if (requestRef.current) {
            cancelAnimationFrame(requestRef.current);
        }
        setProgress(0);
    };

    const animate = () => {
        const now = Date.now();
        const elapsed = now - startTimeRef.current;
        const newProgress = Math.min(elapsed / duration, 1);

        setProgress(newProgress * 100);

        if (newProgress < 1) {
            const source = trackingData.source_location;
            const dest = trackingData.destination_location;
            const lat = source.lat + (dest.lat - source.lat) * newProgress;
            const lng = source.lng + (dest.lng - source.lng) * newProgress;

            updateTrackingLocation(lat, lng, newProgress);
            requestRef.current = requestAnimationFrame(animate);
        } else {
            updateTrackingLocation(
                trackingData.destination_location.lat,
                trackingData.destination_location.lng,
                1,
                'Delivered'
            );
            setIsTracking(false);
        }
    };

    const updateTrackingLocation = async (lat, lng, progress, status = null) => {
        try {
            const response = await fetch(`${LOCAL_URL}/api/tracking/${trackingData.tracking_id}/location`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    lat,
                    lng,
                    status: status || (progress >= 1 ? 'Delivered' : 'In Transit'),
                    speed_kmh: 60,
                    notes: `Progress: ${(progress * 100).toFixed(0)}%`
                })
            });

            if (response.ok) {
                const data = await response.json();
                setTrackingData(data);
            }
        } catch (error) {
            console.error("Failed to update location", error);
        }
    };

    useEffect(() => {
        return () => {
            if (requestRef.current) {
                cancelAnimationFrame(requestRef.current);
            }
        };
    }, []);

    const getStatusColor = (status) => {
        switch (status) {
            case 'Delivered':
                return 'bg-green-100 text-green-800';
            case 'In Transit':
                return 'bg-blue-100 text-blue-800';
            case 'Delayed':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-yellow-100 text-yellow-800';
        }
    };

    if (isLoading) {
        return (
            <div className="flex justify-center items-center h-screen">
                <div className="text-center">
                    <Truck className="w-12 h-12 text-blue-500 animate-pulse mx-auto mb-4" />
                    <p className="text-slate-600">Loading...</p>
                </div>
            </div>
        );
    }

    // Ordering Mode UI
    if (mode === 'ordering' && materialInfo) {
        return (
            <div className="bg-[#f5f8fd] p-6 md:p-8 space-y-6 min-h-screen">
                <div>
                    <h1 className="text-3xl font-bold text-slate-900">Order Material</h1>
                    <p className="text-slate-500 mt-1">Select supplier for {materialInfo.name}</p>
                </div>

                {showLocationPicker ? (
                    <Card className="bg-white border-slate-200">
                        <CardHeader>
                            <CardTitle className="flex items-center gap-2">
                                <MapPinned className="w-5 h-5 text-blue-600" />
                                Set Project Location
                            </CardTitle>
                            <p className="text-sm text-slate-500">Click on the map to select your project location</p>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <div className="h-[400px] rounded-lg overflow-hidden">
                                <MapContainer
                                    center={[tempLocation?.lat || 20.5937, tempLocation?.lng || 78.9629]}
                                    zoom={5}
                                    style={{ height: '100%', width: '100%' }}
                                >
                                    <TileLayer
                                        url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                                        attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                    />
                                    <LocationPicker onLocationSelect={handleMapClick} />
                                    {tempLocation && (
                                        <Marker position={[tempLocation.lat, tempLocation.lng]} icon={pinIcon}>
                                            <Popup>
                                                <div className="text-sm">
                                                    <p className="font-bold">Selected Location</p>
                                                    <p>Lat: {tempLocation.lat.toFixed(4)}</p>
                                                    <p>Lng: {tempLocation.lng.toFixed(4)}</p>
                                                </div>
                                            </Popup>
                                        </Marker>
                                    )}
                                    <MapResizer />
                                </MapContainer>
                            </div>
                            {tempLocation && (
                                <div className="flex justify-between items-center">
                                    <div className="text-sm text-slate-600">
                                        Selected: {tempLocation.lat.toFixed(4)}, {tempLocation.lng.toFixed(4)}
                                    </div>
                                    <Button onClick={handleSaveLocation} className="bg-blue-600 hover:bg-blue-700">
                                        Save Location
                                    </Button>
                                </div>
                            )}
                        </CardContent>
                    </Card>
                ) : (
                    <>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 space-y-4">
                                <Card className="bg-white border-slate-200">
                                    <CardHeader>
                                        <CardTitle className="flex items-center gap-2">
                                            <Store className="w-5 h-5 text-blue-600" />
                                            Available Suppliers
                                        </CardTitle>
                                    </CardHeader>
                                    <CardContent>
                                        {suppliers.length === 0 ? (
                                            <p className="text-slate-500 text-center py-8">No suppliers found for this material</p>
                                        ) : (
                                            <div className="space-y-3">
                                                {suppliers.map((supplier) => (
                                                    <div
                                                        key={supplier._id}
                                                        className={`p-4 border rounded-lg cursor-pointer transition-all ${selectedSupplier?._id === supplier._id
                                                                ? 'border-blue-500 bg-blue-50'
                                                                : 'border-slate-200 hover:border-blue-300'
                                                            }`}
                                                        onClick={() => setSelectedSupplier(supplier)}
                                                    >
                                                        <div className="flex justify-between items-start">
                                                            <div>
                                                                <h3 className="font-semibold text-slate-900">{supplier.name}</h3>
                                                                <p className="text-sm text-slate-600">{supplier.address}</p>
                                                                <div className="flex gap-2 mt-2">
                                                                    <Badge variant="outline" className="text-xs">
                                                                        Rating: {supplier.reliability_score}/10
                                                                    </Badge>
                                                                    <Badge variant="outline" className="text-xs">
                                                                        Delivery: {supplier.average_delivery_days} days
                                                                    </Badge>
                                                                    {supplier.distance_km && (
                                                                        <Badge variant="outline" className="text-xs">
                                                                            {supplier.distance_km} km away
                                                                        </Badge>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </CardContent>
                                </Card>
                            </div>

                            <div>
                                <Card className="bg-white border-slate-200 sticky top-6">
                                    <CardHeader>
                                        <CardTitle>Order Summary</CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <div className="space-y-2">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-slate-600">Material:</span>
                                                <span className="font-medium">{materialInfo.name}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-slate-600">Quantity:</span>
                                                <span className="font-medium">{materialInfo.quantity} {materialInfo.unit}</span>
                                            </div>
                                            {selectedSupplier && (
                                                <>
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-slate-600">Supplier:</span>
                                                        <span className="font-medium">{selectedSupplier.name}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-slate-600">Est. Delivery:</span>
                                                        <span className="font-medium">{selectedSupplier.average_delivery_days} days</span>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                        <Button
                                            className="w-full bg-blue-600 hover:bg-blue-700"
                                            onClick={handlePlaceOrder}
                                            disabled={!selectedSupplier || isPlacingOrder}
                                        >
                                            {isPlacingOrder ? 'Placing Order...' : 'Place Order'}
                                        </Button>
                                    </CardContent>
                                </Card>
                            </div>
                        </div>

                        {/* Map View - Show route when supplier is selected */}
                        {selectedSupplier && projectLocation && (
                            <Card className="bg-white border-slate-200">
                                <CardHeader className="border-b border-slate-100 bg-slate-50/50">
                                    <CardTitle className="flex items-center gap-2 text-base">
                                        <MapPin className="w-5 h-5 text-green-600" />
                                        Delivery Route Preview
                                    </CardTitle>
                                    <p className="text-sm text-slate-500 mt-1">
                                        From {selectedSupplier.name} to your project site
                                        {selectedSupplier.distance_km && ` (${selectedSupplier.distance_km} km)`}
                                    </p>
                                </CardHeader>
                                <div className="h-[500px] relative">
                                    <MapContainer
                                        center={[
                                            (selectedSupplier.location.lat + projectLocation.lat) / 2,
                                            (selectedSupplier.location.lng + projectLocation.lng) / 2
                                        ]}
                                        zoom={6}
                                        style={{ height: '100%', width: '100%' }}
                                    >
                                        <TileLayer
                                            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                                            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                        />
                                        <MapResizer />

                                        {/* Supplier Location Marker */}
                                        <Marker position={[selectedSupplier.location.lat, selectedSupplier.location.lng]} icon={truckIcon}>
                                            <Popup>
                                                <div className="text-sm">
                                                    <p className="font-bold">Supplier Location</p>
                                                    <p>{selectedSupplier.name}</p>
                                                    <p className="text-xs text-slate-600">{selectedSupplier.address}</p>
                                                </div>
                                            </Popup>
                                        </Marker>

                                        {/* Project Location Marker */}
                                        <Marker position={[projectLocation.lat, projectLocation.lng]} icon={pinIcon}>
                                            <Popup>
                                                <div className="text-sm">
                                                    <p className="font-bold">Project Site</p>
                                                    <p>Delivery Destination</p>
                                                </div>
                                            </Popup>
                                        </Marker>

                                        {/* Route Line */}
                                        <Polyline
                                            positions={[
                                                [selectedSupplier.location.lat, selectedSupplier.location.lng],
                                                [projectLocation.lat, projectLocation.lng]
                                            ]}
                                            color="#3b82f6"
                                            weight={3}
                                            opacity={0.7}
                                            dashArray="10, 10"
                                        />

                                        <RouteFitter
                                            source={[selectedSupplier.location.lat, selectedSupplier.location.lng]}
                                            destination={[projectLocation.lat, projectLocation.lng]}
                                            route={null}
                                        />
                                    </MapContainer>
                                </div>
                            </Card>
                        )}
                    </>
                )}
            </div>
        );
    }

    // Tracking Mode UI (original)
    return (
        <div className="bg-[#f5f8fd] p-6 md:p-8 space-y-6 min-h-screen">
            <div>
                <h1 className="text-3xl font-bold text-slate-900">Live Material Tracking</h1>
                <p className="text-slate-500 mt-1">Monitor real-time shipment status and location</p>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <Card className="bg-white border-slate-200 h-fit">
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                            <Navigation className="w-5 h-5 text-blue-600" />
                            Tracking Details
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-6">
                        <div className="space-y-2">
                            <Label htmlFor="order">Select Order</Label>
                            <Select value={selectedOrder} onValueChange={handleOrderSelect} disabled={isTracking}>
                                <SelectTrigger>
                                    <SelectValue placeholder="Select an Order" />
                                </SelectTrigger>
                                <SelectContent>
                                    {activeOrders.length > 0 ? (
                                        activeOrders.map(tracking => (
                                            <SelectItem key={tracking._id} value={tracking.order._id}>
                                                {tracking.order.material_name} - {tracking.tracking_id}
                                            </SelectItem>
                                        ))
                                    ) : (
                                        <SelectItem value="none" disabled>No active orders</SelectItem>
                                    )}
                                </SelectContent>
                            </Select>
                        </div>

                        {trackingData && (
                            <>
                                <div className="space-y-3 p-4 bg-slate-50 rounded-lg">
                                    <div className="flex justify-between text-sm">
                                        <span className="text-slate-600">Material:</span>
                                        <span className="font-medium text-slate-900">{trackingData.order?.material_name}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="text-slate-600">Quantity:</span>
                                        <span className="font-medium text-slate-900">{trackingData.order?.quantity} {trackingData.order?.unit}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="text-slate-600">Tracking ID:</span>
                                        <span className="font-mono text-xs text-slate-900">{trackingData.tracking_id}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="text-slate-600">Status:</span>
                                        <Badge className={getStatusColor(trackingData.status)}>{trackingData.status}</Badge>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="text-slate-600">Distance:</span>
                                        <span className="font-medium text-slate-900">{trackingData.distance_km} km</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="text-slate-600">Covered:</span>
                                        <span className="font-medium text-slate-900">{trackingData.distance_covered_km} km</span>
                                    </div>
                                    {trackingData.eta && (
                                        <div className="flex justify-between text-sm">
                                            <span className="text-slate-600">ETA:</span>
                                            <span className="font-medium text-slate-900">{new Date(trackingData.eta).toLocaleDateString()}</span>
                                        </div>
                                    )}
                                </div>

                                {!isTracking ? (
                                    <Button
                                        className="w-full bg-blue-600 hover:bg-blue-700"
                                        onClick={handleStartTracking}
                                        disabled={trackingData.status === 'Delivered'}
                                    >
                                        <PlayCircle className="w-4 h-4 mr-2" />
                                        Start Tracking
                                    </Button>
                                ) : (
                                    <Button className="w-full bg-red-600 hover:bg-red-700" onClick={handleStopTracking}>
                                        <StopCircle className="w-4 h-4 mr-2" />
                                        Stop Tracking
                                    </Button>
                                )}

                                {isTracking && (
                                    <div className="p-4 bg-blue-50 rounded-lg border border-blue-100 space-y-3">
                                        <div className="flex justify-between text-sm">
                                            <span className="text-slate-600">Progress:</span>
                                            <span className="font-medium text-slate-900">{Math.round(progress)}%</span>
                                        </div>
                                        <div className="w-full bg-blue-200 rounded-full h-2">
                                            <div
                                                className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                                style={{ width: `${progress}%` }}
                                            ></div>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-slate-600">Speed:</span>
                                            <span className="font-medium text-slate-900">{trackingData.speed_kmh || 60} km/h</span>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </CardContent>
                </Card>

                <Card className="lg:col-span-2 bg-white border-slate-200 overflow-hidden flex flex-col">
                    <CardHeader className="border-b border-slate-100 bg-slate-50/50">
                        <div className="flex justify-between items-center">
                            <CardTitle className="flex items-center gap-2 text-base">
                                <MapPin className="w-5 h-5 text-green-600" />
                                Live Map View
                            </CardTitle>
                            {isTracking && (
                                <div className="flex items-center gap-2 text-sm text-slate-500 animate-pulse">
                                    <span className="relative flex h-3 w-3">
                                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                        <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                                    </span>
                                    Live Updates
                                </div>
                            )}
                        </div>
                    </CardHeader>
                    <div className="flex-1 min-h-[500px] relative">
                        <MapContainer
                            center={[20.5937, 78.9629]}
                            zoom={5}
                            style={{ height: '100%', width: '100%', position: 'absolute' }}
                        >
                            <TileLayer
                                url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                                attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                            />
                            <MapResizer />

                            {trackingData && (
                                <>
                                    <Marker position={[trackingData.source_location.lat, trackingData.source_location.lng]} icon={pinIcon}>
                                        <Popup>
                                            <div className="text-sm">
                                                <p className="font-bold">Source</p>
                                                <p>{trackingData.source_location.address}</p>
                                            </div>
                                        </Popup>
                                    </Marker>

                                    <Marker position={[trackingData.destination_location.lat, trackingData.destination_location.lng]} icon={pinIcon}>
                                        <Popup>
                                            <div className="text-sm">
                                                <p className="font-bold">Destination</p>
                                                <p>{trackingData.destination_location.address}</p>
                                            </div>
                                        </Popup>
                                    </Marker>

                                    {trackingData.current_location && (
                                        <Marker position={[trackingData.current_location.lat, trackingData.current_location.lng]} icon={truckIcon}>
                                            <Popup>
                                                <div className="text-sm">
                                                    <p className="font-bold">Tracking ID: {trackingData.tracking_id}</p>
                                                    <p>Status: {trackingData.status}</p>
                                                    <p>Speed: {trackingData.speed_kmh || 60} km/h</p>
                                                    <p>Material: {trackingData.order?.material_name}</p>
                                                </div>
                                            </Popup>
                                        </Marker>
                                    )}

                                    <Polyline
                                        positions={[
                                            [selectedSupplier.location.lat, selectedSupplier.location.lng],
                                            [projectLocation.lat, projectLocation.lng]
                                        ]}
                                        color="#3b82f6"
                                        weight={3}
                                        opacity={0.7}
                                        dashArray="10, 10"
                                    />

                                    <RouteFitter
                                        source={[selectedSupplier.location.lat, selectedSupplier.location.lng]}
                                        destination={[projectLocation.lat, projectLocation.lng]}
                                        route={null}
                                    />
                                </>
                            )}
                        </MapContainer>
                    </div>
                </Card>
            </div>
        </div>
    );
}